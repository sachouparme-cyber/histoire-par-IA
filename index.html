<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <title>R√âCITS INFINIS - Ultimate Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=Courier+Prime&display=swap');
        
        /* ========== THEMES ========== */
        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #222;
            --bg-tertiary: #2a2a2a;
            --text-primary: #e8e8e8;
            --text-secondary: #999;
            --border-color: #444;
            --accent: #667eea;
            --accent-hover: #5568d3;
            --success: #4ade80;
            --danger: #ff4444;
            --warning: #fbbf24;
        }
        
        :root[data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --border-color: #ddd;
            --accent: #667eea;
            --accent-hover: #5568d3;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'EB Garamond', serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.8;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        /* ========== HEADER ========== */
        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 20px;
            position: relative;
        }
        
        .header h1 { font-size: 48px; margin-bottom: 10px; letter-spacing: 2px; }
        .tagline { color: var(--text-secondary); font-style: italic; }
        
        .header-controls {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
        }
        
        .icon-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 50%;
            font-size: 20px;
            transition: all 0.3s;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-btn:hover {
            border-color: var(--accent);
            transform: scale(1.1);
        }
        
        /* ========== PROFILE ========== */
        .profile-bar {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid var(--border-color);
        }
        
        .profile-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }
        
        .profile-name {
            font-size: 24px;
            font-weight: bold;
            font-family: 'Courier Prime', monospace;
        }
        
        .profile-stats {
            display: flex;
            gap: 30px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        /* ========== MENU ========== */
        .main-menu {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .menu-card {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
            border: 3px solid var(--border-color);
            padding: 30px 40px;
            cursor: pointer;
            border-radius: 15px;
            transition: all 0.4s;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-width: 220px;
        }
        
        .menu-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: var(--accent);
            opacity: 0.2;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .menu-card:hover::before {
            width: 400px;
            height: 400px;
        }
        
        .menu-card:hover {
            border-color: var(--accent);
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
        }
        
        .menu-icon {
            font-size: 60px;
            display: block;
            margin-bottom: 10px;
            transition: all 0.3s;
            position: relative;
            z-index: 1;
        }
        
        .menu-card:hover .menu-icon {
            transform: scale(1.2) rotate(5deg);
        }
        
        .menu-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }
        
        .menu-desc {
            font-size: 14px;
            color: var(--text-secondary);
            position: relative;
            z-index: 1;
        }
        
        /* ========== RUNNER GAME ========== */
        #runnerGame {
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-family: 'Courier Prime', monospace;
            font-size: 20px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .game-stat {
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 8px;
        }
        
        #gameCanvas {
            display: block;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            max-width: 100%;
        }
        
        .game-over-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            min-width: 300px;
        }
        
        .game-over-screen h2 {
            font-size: 42px;
            color: var(--danger);
            margin-bottom: 20px;
        }
        
        .final-stats {
            margin: 20px 0;
        }
        
        .final-stat {
            font-size: 24px;
            margin: 10px 0;
            color: var(--accent);
        }
        
        .btn-primary {
            background: var(--accent);
            border: none;
            color: #fff;
            padding: 15px 40px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 8px;
            font-family: 'Courier Prime', monospace;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }
        
        .mobile-controls {
            margin-top: 20px;
            display: none;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: var(--accent);
            border: none;
            color: #fff;
            padding: 20px 30px;
            font-size: 32px;
            cursor: pointer;
            border-radius: 12px;
            min-width: 80px;
            user-select: none;
            touch-action: manipulation;
            transition: all 0.2s;
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        .control-btn.jump {
            background: var(--success);
        }
        
        /* ========== POWERUPS ========== */
        .powerup-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .powerup-icon {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            font-size: 24px;
            position: relative;
        }
        
        .powerup-icon.active {
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* ========== SKINS SHOP ========== */
        .skins-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .skin-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .skin-card:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
        }
        
        .skin-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .skin-card.selected {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
        }
        
        .skin-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .skin-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .skin-price {
            color: var(--warning);
            font-size: 14px;
        }
        
        /* ========== LEADERBOARD ========== */
        .leaderboard {
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .leaderboard-item:hover {
            background: var(--bg-tertiary);
        }
        
        .leaderboard-rank {
            font-size: 24px;
            font-weight: bold;
            width: 50px;
        }
        
        .rank-gold { color: #FFD700; }
        .rank-silver { color: #C0C0C0; }
        .rank-bronze { color: #CD7F32; }
        
        .leaderboard-name {
            flex: 1;
            font-size: 18px;
        }
        
        .leaderboard-score {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent);
        }
        
        /* ========== STORIES ========== */
        .story-card {
            background: var(--bg-secondary);
            padding: 20px;
            margin: 15px 0;
            border-left: 3px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 4px;
        }
        
        .story-card:hover {
            border-left-color: var(--accent);
            background: var(--bg-tertiary);
            transform: translateX(5px);
        }
        
        .story-card h3 { margin-bottom: 8px; font-size: 22px; }
        .story-card p { color: var(--text-secondary); font-size: 16px; margin: 0; }
        
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .badge.complete { background: rgba(74, 222, 128, 0.3); color: var(--success); }
        .badge.dev { background: rgba(150,150,150,0.3); color: var(--text-secondary); }
        
        .genre-btn {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.3s;
            font-family: 'Courier Prime', monospace;
            margin: 5px;
        }
        
        .genre-btn:hover, .genre-btn.active {
            border-color: var(--accent);
            color: var(--text-primary);
            background: rgba(102, 126, 234, 0.1);
        }
        
        .story-text {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 19px;
            border: 1px solid var(--border-color);
        }
        
        .choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 18px 25px;
            font-family: 'EB Garamond', serif;
            font-size: 18px;
            cursor: pointer;
            text-align: left;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .choice-btn:hover {
            border-color: var(--accent);
            background: rgba(102, 126, 234, 0.1);
            transform: translateX(5px);
        }
        
        .ending {
            background: linear-gradient(135deg, var(--accent) 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            color: #fff;
        }
        
        /* ========== LANGUAGE SELECTOR ========== */
        .lang-selector {
            display: flex;
            gap: 5px;
            background: var(--bg-secondary);
            padding: 5px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
        }
        
        .lang-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 15px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .lang-btn:hover, .lang-btn.active {
            background: var(--accent);
            color: #fff;
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .header h1 { font-size: 36px; }
            .profile-bar { flex-direction: column; text-align: center; }
            .profile-stats { margin-top: 15px; }
            .menu-card { min-width: 100%; }
            .header-controls { position: static; justify-content: center; margin-top: 15px; }
        }
        
        /* ========== ANIMATIONS OPTIMIS√âES ========== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Apply light animations only */
        .menu-card {
            animation: fadeIn 0.5s ease-out both;
            transition: all 0.3s ease;
        }
        
        .menu-card:nth-child(1) { animation-delay: 0.1s; }
        .menu-card:nth-child(2) { animation-delay: 0.15s; }
        .menu-card:nth-child(3) { animation-delay: 0.2s; }
        .menu-card:nth-child(4) { animation-delay: 0.25s; }
        .menu-card:nth-child(5) { animation-delay: 0.3s; }
        
        .menu-card:hover .menu-icon {
            transform: scale(1.15);
        }
        
        .btn-primary {
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .choice-btn {
            animation: slideIn 0.3s ease-out both;
            transition: all 0.2s ease;
        }
        
        .choice-btn:nth-child(1) { animation-delay: 0.05s; }
        .choice-btn:nth-child(2) { animation-delay: 0.1s; }
        .choice-btn:nth-child(3) { animation-delay: 0.15s; }
        .choice-btn:nth-child(4) { animation-delay: 0.2s; }
        
        .story-text {
            animation: fadeIn 0.4s ease-out;
        }
        
        .story-card {
            animation: fadeIn 0.4s ease-out both;
            transition: all 0.2s ease;
        }
        
        .story-card:nth-child(1) { animation-delay: 0.05s; }
        .story-card:nth-child(2) { animation-delay: 0.1s; }
        .story-card:nth-child(3) { animation-delay: 0.15s; }
        
        .icon-btn {
            transition: transform 0.2s ease;
        }
        
        .icon-btn:hover {
            transform: scale(1.1);
        }
        
        .hidden { display: none !important; }
        
        /* ========== CHAT WINDOW ========== */
        #chatWindow {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: var(--bg-secondary);
            border: 3px solid var(--accent);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            z-index: 9999;
            font-family: 'Courier Prime', monospace;
        }
        
        #chatWindow.open {
            display: flex;
        }
        
        .chat-header {
            background: var(--accent);
            color: #fff;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .chat-close {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-close:hover {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: var(--bg-primary);
        }
        
        .chat-message {
            margin-bottom: 12px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            animation: slideIn 0.3s ease-out;
        }
        
        .chat-message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .chat-avatar {
            font-size: 20px;
        }
        
        .chat-username {
            font-weight: bold;
            color: var(--accent);
        }
        
        .chat-time {
            color: var(--text-secondary);
            font-size: 11px;
            margin-left: auto;
        }
        
        .chat-text {
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .chat-input-area {
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 0 0 12px 12px;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 8px;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .chat-send-btn {
            background: var(--accent);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .chat-send-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }
        
        .chat-send-btn:active {
            transform: scale(0.95);
        }
        
        .chat-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }
        
        @media (max-width: 768px) {
            #chatWindow {
                width: 100%;
                height: 100%;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }
            
            .chat-header {
                border-radius: 0;
            }
            
            .chat-input-area {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1 data-i18n="title">R√âCITS INFINIS</h1>
            <div class="tagline" data-i18n="tagline">Ultimate Edition ‚Ä¢ Histoires & Jeux</div>
            <div class="header-controls">
                <div class="lang-selector">
                    <button class="lang-btn active" onclick="setLanguage('fr')">üá´üá∑</button>
                    <button class="lang-btn" onclick="setLanguage('en')">üá¨üáß</button>
                    <button class="lang-btn" onclick="setLanguage('es')">üá™üá∏</button>
                </div>
                <button class="icon-btn" id="themeToggle" onclick="toggleTheme()" title="Changer le th√®me">üåô</button>
                <button class="icon-btn" onclick="toggleChat()" title="Chat global" id="chatBtn">üí¨</button>
                <button class="icon-btn" id="btnCreateAccount" onclick="showCreateAccountModal()" title="Cr√©er un compte" style="background: #4ade80; border-color: #4ade80;">‚ú®</button>
                <button class="icon-btn" id="btnLogin" onclick="showLoginModal()" title="Se connecter">üîê</button>
                <button class="icon-btn" id="btnProfile" onclick="editProfile()" title="Mon profil" style="display: none;">üë§</button>
                <button class="icon-btn" onclick="downloadSite()" title="T√©l√©charger le site">üíæ</button>
            </div>
        </div>
        
        <!-- PROFILE BAR -->
        <div class="profile-bar">
            <div class="profile-info">
                <div class="profile-avatar" id="profileAvatar">üòé</div>
                <div>
                    <div class="profile-name" id="profileName">Joueur</div>
                    <div style="color: var(--text-secondary); font-size: 14px;" data-i18n="level">Niveau <span id="playerLevel">1</span></div>
                </div>
            </div>
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalCoins">0</div>
                    <div class="stat-label" data-i18n="coins">Pi√®ces</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalStories">0</div>
                    <div class="stat-label" data-i18n="stories">Histoires</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="highScore">0</div>
                    <div class="stat-label" data-i18n="highscore">Record</div>
                </div>
            </div>
        </div>
        
        <!-- WARNING BANNER FOR NON-LOGGED USERS -->
        <div id="warningBanner" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 20px; border-radius: 10px; margin-bottom: 30px; text-align: center; border: 3px solid #ff4757; display: none;">
            <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è ATTENTION ‚ö†Ô∏è</div>
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">Tu n'es pas connect√© !</div>
            <div style="font-size: 16px; margin-bottom: 15px;">Sans compte, tu perdras toute ta progression (pi√®ces, skins, scores) si tu quittes le site !</div>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn-primary" onclick="showCreateAccountModal()" style="background: #4ade80;">‚ú® CR√âER UN COMPTE</button>
                <button class="btn-primary" onclick="showLoginModal()">üîê SE CONNECTER</button>
            </div>
        </div>
        
        <!-- MAIN MENU -->
        <div id="mainMenu">
            <div class="main-menu">
                <div class="menu-card" onclick="showSection('stories')">
                    <span class="menu-icon">üìñ</span>
                    <div class="menu-title" data-i18n="stories-title">HISTOIRES</div>
                    <div class="menu-desc" data-i18n="stories-desc">30 aventures interactives</div>
                </div>
                <div class="menu-card" onclick="showSection('runner')">
                    <span class="menu-icon">üèÉ</span>
                    <div class="menu-title" data-i18n="runner-title">RUNNER GAME</div>
                    <div class="menu-desc" data-i18n="runner-desc">Cours et √©vite les obstacles</div>
                </div>
                <div class="menu-card" onclick="showSection('shop')">
                    <span class="menu-icon">üõçÔ∏è</span>
                    <div class="menu-title" data-i18n="shop-title">BOUTIQUE</div>
                    <div class="menu-desc" data-i18n="shop-desc">D√©bloquer des skins</div>
                </div>
                <div class="menu-card" onclick="showSection('leaderboard')">
                    <span class="menu-icon">üèÜ</span>
                    <div class="menu-title" data-i18n="leaderboard-title">CLASSEMENT</div>
                    <div class="menu-desc" data-i18n="leaderboard-desc">Top 10 des scores</div>
                </div>
                <div class="menu-card" style="opacity: 0.6; cursor: not-allowed; border-color: #666;" onclick="alert('üöß Snake Game\n\nCe jeu classique arrive bient√¥t !\nEn attendant, profite du Runner Game et des histoires interactives.')">
                    <span class="menu-icon">üêç</span>
                    <div class="menu-title">SNAKE GAME</div>
                    <div class="menu-desc">üöß Bient√¥t disponible</div>
                </div>
            </div>
        </div>
        
        <!-- SECTIONS (to be filled with content) -->
        <div id="contentArea"></div>
    </div>
    
    <!-- CHAT WINDOW -->
    <div id="chatWindow">
        <div class="chat-header">
            <span>üí¨ CHAT GLOBAL</span>
            <button class="chat-close" onclick="toggleChat()">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                Chargement des messages...
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Tape ton message..." maxlength="200" onkeypress="if(event.key==='Enter') sendChatMessage()">
            <button class="chat-send-btn" onclick="sendChatMessage()">üì§</button>
        </div>
    </div>
    
    <!-- AUDIO ELEMENTS -->
    <audio id="coinSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjGH0fPTgjMGHm7A7+OZWA0GSleh6rllHAY4jtLyzn0pBSl+zPLakzoIGGS56+mgUhELTKXh8btoHgU2jdXyzII0Bh1xy/DflVkPCk+m4/G5Zx4GN4/U8tGBLwcogszzqZlOEAtPp+PxtWceBTeP1fLSgS8HJ4fO86uXUBELTqfj8bVnHgU3j9Xy0oEvByiCzPOplk4QC06n4/K3aR4FN4/V8tKBLwcng8zzq5lPEAA=" type="audio/wav">
    </audio>
    <audio id="jumpSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjGH0fPTgjMGHm7A7+OZWA0GSleh6rllHAY4jtLyzn0pBSl+zPLakzoIGGS56+mgUhELTKXh8btoHgU2jdXyzII0Bh1xy/DflVkPCk+m4/G5Zx4GN4/U8tGBLwcogszzqZlOEAtPp+PxtWceBTeP1fLSgS8HJ4fO86uXUBELTqfj8bVnHgU3j9Xy0oEvByiCzPOplk4QC06n4/K3aR4FN4/V8tKBLwcng8zzq5lPEAA=" type="audio/wav">
    </audio>
    <audio id="gameoverSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRhQDAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YPAHAAB/gH9/gIGAgYGCgoGBgYF/gIB/gIGAgYGBgYGAgYGAgH9/gH+AgIGBgYGBgYGBgYGAgH9/f4CAgYGBgYGBgYGBgIGBgYB/f3+AgIGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgICAgH9/f4CAgYGBgYGBgYGBgYGBgICAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4A=" type="audio/wav">
    </audio>
    <audio id="powerupSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRhQDAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YPAHAAB/gH9/gIGAgYGCgoGBgYF/gIB/gIGAgYGBgYGAgYGAgH9/gH+AgIGBgYGBgYGBgYGAgH9/f4CAgYGBgYGBgYGBgIGBgYB/f3+AgIGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgICAgH9/f4CAgYGBgYGBgYGBgYGBgICAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4CAgYGBgYGBgYGBgYGBgYCAgH9/f4A=" type="audio/wav">
    </audio>

    <script>
        // ========== SUPABASE CONFIGURATION ==========
        const SUPABASE_URL = 'https://wsxqgtzyhglmeddybzgn.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ix9Cb9aP0eDcvreT2fX1jg_DqWqZHjS';
        
        let supabaseClient = null;
        let currentUser = null;
        
        // Initialize Supabase safely
        if (typeof supabase !== 'undefined') {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase connect√© !');
            } catch (error) {
                console.error('‚ùå Erreur Supabase:', error);
            }
        } else {
            console.warn('‚ö†Ô∏è Supabase non charg√© - mode local uniquement');
        }
        
        // ========== GLOBAL STATE ==========
        const STATE = {
            currentLang: 'fr',
            theme: 'dark',
            profile: {
                name: 'Joueur',
                avatar: 'üòé',
                level: 1,
                totalCoins: 0,
                storiesCompleted: 0,
                highScore: 0
            },
            runnerGame: {
                score: 0,
                coins: 0,
                speed: 5,
                powerups: [],
                currentSkin: 'default',
                unlockedSkins: ['default'],
                leaderboard: []
            }
        };
        
        // ========== TRANSLATIONS ==========
        const translations = {
            fr: {
                title: 'R√âCITS INFINIS',
                tagline: 'Ultimate Edition ‚Ä¢ Histoires & Jeux',
                level: 'Niveau',
                coins: 'Pi√®ces',
                stories: 'Histoires',
                highscore: 'Record',
                'stories-title': 'HISTOIRES',
                'stories-desc': '30 aventures interactives',
                'runner-title': 'RUNNER GAME',
                'runner-desc': 'Cours et √©vite les obstacles',
                'shop-title': 'BOUTIQUE',
                'shop-desc': 'D√©bloquer des skins',
                'leaderboard-title': 'CLASSEMENT',
                'leaderboard-desc': 'Top 10 des scores'
            },
            en: {
                title: 'INFINITE TALES',
                tagline: 'Ultimate Edition ‚Ä¢ Stories & Games',
                level: 'Level',
                coins: 'Coins',
                stories: 'Stories',
                highscore: 'High Score',
                'stories-title': 'STORIES',
                'stories-desc': '30 interactive adventures',
                'runner-title': 'RUNNER GAME',
                'runner-desc': 'Run and avoid obstacles',
                'shop-title': 'SHOP',
                'shop-desc': 'Unlock skins',
                'leaderboard-title': 'LEADERBOARD',
                'leaderboard-desc': 'Top 10 scores'
            },
            es: {
                title: 'CUENTOS INFINITOS',
                tagline: 'Ultimate Edition ‚Ä¢ Historias y Juegos',
                level: 'Nivel',
                coins: 'Monedas',
                stories: 'Historias',
                highscore: 'R√©cord',
                'stories-title': 'HISTORIAS',
                'stories-desc': '30 aventuras interactivas',
                'runner-title': 'JUEGO RUNNER',
                'runner-desc': 'Corre y evita obst√°culos',
                'shop-title': 'TIENDA',
                'shop-desc': 'Desbloquear skins',
                'leaderboard-title': 'CLASIFICACI√ìN',
                'leaderboard-desc': 'Top 10 de puntuaciones'
            }
        };
        
        // ========== INITIALIZATION ==========
        function init() {
            loadState();
            updateUI();
            setupEventListeners();
            updateAuthButtons();
        }
        
        function loadState() {
            const saved = localStorage.getItem('recitsInfinisState');
            if (saved) {
                Object.assign(STATE, JSON.parse(saved));
            }
        }
        
        function saveState() {
            localStorage.setItem('recitsInfinisState', JSON.stringify(STATE));
            if (currentUser) {
                syncToSupabase();
            }
        }
        
        function updateUI() {
            const profileName = document.getElementById('profileName');
            const profileAvatar = document.getElementById('profileAvatar');
            const playerLevel = document.getElementById('playerLevel');
            const totalCoins = document.getElementById('totalCoins');
            const totalStories = document.getElementById('totalStories');
            const highScore = document.getElementById('highScore');
            const themeBtn = document.getElementById('themeToggle');
            
            if (profileName) profileName.textContent = STATE.profile.name;
            if (profileAvatar) profileAvatar.textContent = STATE.profile.avatar;
            if (playerLevel) playerLevel.textContent = STATE.profile.level;
            if (totalCoins) totalCoins.textContent = STATE.profile.totalCoins;
            if (totalStories) totalStories.textContent = STATE.profile.storiesCompleted;
            if (highScore) highScore.textContent = STATE.profile.highScore;
            
            // Apply theme
            document.documentElement.setAttribute('data-theme', STATE.theme);
            if (themeBtn) themeBtn.textContent = STATE.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            
            updateTranslations();
        }
        
        function setupEventListeners() {
            // Mobile detection
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                // Will show mobile controls when runner starts
            }
        }
        
        // ========== THEME TOGGLE ==========
        function toggleTheme() {
            STATE.theme = STATE.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', STATE.theme);
            const themeBtn = document.getElementById('themeToggle');
            if (themeBtn) themeBtn.textContent = STATE.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            saveState();
        }
        
        // ========== AUTHENTICATION SYSTEM ==========
        let pendingVerification = null;
        
        async function showCreateAccountModal() {
            const email = prompt('‚ú® CR√âER UN COMPTE\n\nüìß Entre ton adresse email:');
            if (!email || !email.includes('@')) {
                alert('‚ùå Email invalide !');
                return;
            }
            
            const username = prompt('üë§ Choisis ton pseudo:');
            if (!username || username.trim().length === 0) {
                alert('‚ùå Pseudo invalide !');
                return;
            }
            
            await createAccount(email.trim(), username.trim());
        }
        
        async function createAccount(email, username) {
            if (!supabaseClient) {
                alert('‚ö†Ô∏è Service cloud non disponible.\nCr√©ation de compte impossible.');
                return;
            }
            
            try {
                // Check if user exists
                const { data: existingUser } = await supabaseClient
                    .from('users')
                    .select('email')
                    .eq('email', email)
                    .single();
                
                if (existingUser) {
                    alert('‚ùå Cet email est d√©j√† utilis√© !\n\nUtilise le bouton "Se connecter" üîê');
                    return;
                }
                
                // Generate 6-digit code
                const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
                
                // Store pending verification
                pendingVerification = {
                    email: email,
                    username: username,
                    code: verificationCode,
                    type: 'create',
                    timestamp: Date.now()
                };
                
                // Send email (simulation - in reality would use Supabase Edge Functions)
                await sendVerificationEmail(email, verificationCode, 'create');
                
                // Ask for code
                const enteredCode = prompt(`üìß Un code √† 6 chiffres a √©t√© envoy√© √†:\n${email}\n\nüî¢ Entre le code:`);
                
                if (enteredCode === verificationCode) {
                    await finalizeAccountCreation();
                } else {
                    alert('‚ùå Code incorrect !\n\nR√©essaye.');
                    pendingVerification = null;
                }
                
            } catch (error) {
                console.error('Erreur cr√©ation compte:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }
        
        async function finalizeAccountCreation() {
            if (!pendingVerification) return;
            
            try {
                const { data: newUser, error } = await supabaseClient
                    .from('users')
                    .insert([{
                        email: pendingVerification.email,
                        username: pendingVerification.username,
                        avatar: 'üòé',
                        level: 1,
                        total_coins: 0,
                        stories_completed: 0,
                        high_score: 0,
                        unlocked_skins: ['default'],
                        current_skin: 'default'
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                currentUser = newUser;
                STATE.profile = {
                    name: newUser.username,
                    avatar: 'üòé',
                    level: 1,
                    totalCoins: 0,
                    storiesCompleted: 0,
                    highScore: 0
                };
                STATE.runnerGame.unlockedSkins = ['default'];
                STATE.runnerGame.currentSkin = 'default';
                
                saveState();
                updateUI();
                updateAuthButtons();
                
                alert('üéâ COMPTE CR√â√â AVEC SUCC√àS !\n\nBienvenue ' + newUser.username + ' !\n\nTa progression est maintenant sauvegard√©e dans le cloud ! ‚òÅÔ∏è');
                
                pendingVerification = null;
                
            } catch (error) {
                console.error('Erreur finalisation:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }
        
        async function showLoginModal() {
            const email = prompt('üîê CONNEXION\n\nüìß Entre ton adresse email:');
            if (!email || !email.includes('@')) {
                alert('‚ùå Email invalide !');
                return;
            }
            
            await loginWithEmail(email.trim());
        }
        
        async function loginWithEmail(email) {
            if (!supabaseClient) {
                alert('‚ö†Ô∏è Service cloud non disponible.');
                return;
            }
            
            try {
                // Check if user exists
                const { data: user, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (!user) {
                    const createNow = confirm('‚ùå Aucun compte trouv√© avec cet email.\n\n‚ú® Veux-tu cr√©er un compte maintenant ?');
                    if (createNow) {
                        showCreateAccountModal();
                    }
                    return;
                }
                
                // Generate 6-digit code
                const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
                
                pendingVerification = {
                    email: email,
                    user: user,
                    code: verificationCode,
                    type: 'login',
                    timestamp: Date.now()
                };
                
                // Send email
                await sendVerificationEmail(email, verificationCode, 'login');
                
                // Ask for code
                const enteredCode = prompt(`üìß Un code √† 6 chiffres a √©t√© envoy√© √†:\n${email}\n\nüî¢ Entre le code:`);
                
                if (enteredCode === verificationCode) {
                    await finalizeLogin();
                } else {
                    alert('‚ùå Code incorrect !\n\nR√©essaye.');
                    pendingVerification = null;
                }
                
            } catch (error) {
                console.error('Erreur login:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }
        
        async function finalizeLogin() {
            if (!pendingVerification || !pendingVerification.user) return;
            
            const user = pendingVerification.user;
            
            currentUser = user;
            STATE.profile = {
                name: user.username,
                avatar: user.avatar,
                level: user.level,
                totalCoins: user.total_coins,
                storiesCompleted: user.stories_completed,
                highScore: user.high_score
            };
            STATE.runnerGame.unlockedSkins = user.unlocked_skins || ['default'];
            STATE.runnerGame.currentSkin = user.current_skin || 'default';
            
            saveState();
            updateUI();
            updateAuthButtons();
            
            alert('‚úÖ CONNEXION R√âUSSIE !\n\nBon retour ' + user.username + ' ! üéÆ');
            
            pendingVerification = null;
        }
        
        async function sendVerificationEmail(email, code, type) {
            // This simulates sending an email
            // In production, this would call a Supabase Edge Function
            console.log(`üìß Email envoy√© √† ${email}`);
            console.log(`üî¢ Code: ${code}`);
            console.log(`üìù Type: ${type}`);
            
            // For demo purposes, show the code in console
            alert(`üìß EMAIL ENVOY√â !\n\n(En mode d√©mo, le code est: ${code})\n\nEn production, tu recevrais un vrai email.`);
            
            return true;
        }
        
        async function sendRecordEmail(username, score) {
            if (!currentUser) return;
            
            console.log(`üèÜ Nouveau record pour ${username}: ${score} points !`);
            // Would send real email in production via Supabase Edge Function
            
            return true;
        }
        
        async function sendDailyReminder(email, username) {
            console.log(`üìÖ Rappel quotidien envoy√© √† ${username} (${email})`);
            // Would send real email in production
            
            return true;
        }
        
        function updateAuthButtons() {
            const btnCreate = document.getElementById('btnCreateAccount');
            const btnLogin = document.getElementById('btnLogin');
            const btnProfile = document.getElementById('btnProfile');
            const warningBanner = document.getElementById('warningBanner');
            
            if (currentUser) {
                if (btnCreate) btnCreate.style.display = 'none';
                if (btnLogin) btnLogin.style.display = 'none';
                if (btnProfile) btnProfile.style.display = 'flex';
                if (warningBanner) warningBanner.style.display = 'none';
            } else {
                if (btnCreate) btnCreate.style.display = 'flex';
                if (btnLogin) btnLogin.style.display = 'flex';
                if (btnProfile) btnProfile.style.display = 'none';
                if (warningBanner) warningBanner.style.display = 'block';
            }
        }
        
        // ========== SUPABASE LOGIN/SYNC (OLD - KEPT FOR COMPATIBILITY) ==========
        async function loginOrRegister(email, username) {
            if (!supabaseClient) {
                alert('‚ö†Ô∏è Supabase non disponible');
                return;
            }
            
            try {
                const { data: existingUser, error: fetchError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (existingUser) {
                    currentUser = existingUser;
                    STATE.profile = {
                        name: existingUser.username,
                        avatar: existingUser.avatar,
                        level: existingUser.level,
                        totalCoins: existingUser.total_coins,
                        storiesCompleted: existingUser.stories_completed,
                        highScore: existingUser.high_score
                    };
                    STATE.runnerGame.unlockedSkins = existingUser.unlocked_skins || ['default'];
                    STATE.runnerGame.currentSkin = existingUser.current_skin || 'default';
                    
                    alert('‚úÖ Connexion r√©ussie ! Bienvenue ' + existingUser.username + ' !');
                } else {
                    const { data: newUser, error: insertError } = await supabaseClient
                        .from('users')
                        .insert([{
                            email: email,
                            username: username,
                            avatar: 'üòé',
                            level: 1,
                            total_coins: 0,
                            stories_completed: 0,
                            high_score: 0,
                            unlocked_skins: ['default'],
                            current_skin: 'default'
                        }])
                        .select()
                        .single();
                    
                    if (insertError) throw insertError;
                    
                    currentUser = newUser;
                    STATE.profile = {
                        name: username,
                        avatar: 'üòé',
                        level: 1,
                        totalCoins: 0,
                        storiesCompleted: 0,
                        highScore: 0
                    };
                    STATE.runnerGame.unlockedSkins = ['default'];
                    STATE.runnerGame.currentSkin = 'default';
                    
                    alert('üéâ Compte cr√©√© ! Bienvenue ' + username + ' !');
                }
                
                saveState();
                updateUI();
                location.reload();
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }
        
        async function syncToSupabase() {
            if (!currentUser || !supabaseClient) return;
            
            try {
                const { error } = await supabaseClient
                    .from('users')
                    .update({
                        username: STATE.profile.name,
                        avatar: STATE.profile.avatar,
                        level: STATE.profile.level,
                        total_coins: STATE.profile.totalCoins,
                        stories_completed: STATE.profile.storiesCompleted,
                        high_score: STATE.profile.highScore,
                        unlocked_skins: STATE.runnerGame.unlockedSkins,
                        current_skin: STATE.runnerGame.currentSkin
                    })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                console.log('‚úÖ Synchro cloud r√©ussie !');
            } catch (error) {
                console.error('‚ùå Erreur synchro:', error);
            }
        }
        
        // ========== PROFILE EDIT ==========
        function editProfile() {
            // Change name
            const newName = prompt('üìù Entre ton pseudo:', STATE.profile.name);
            if (newName && newName.trim().length > 0) {
                STATE.profile.name = newName.trim();
            }
            
            // Change avatar
            const avatars = ['üòé', 'ü§ì', 'üòà', 'üëΩ', 'ü§ñ', 'ü¶∏', 'üßô', 'ü•∑', 'ü§†', 'üëª', 'üê±', 'üê∂', 'ü¶ä', 'üêº', 'ü¶Å'];
            let avatarMsg = 'üé≠ Choisis ton avatar:\n\n';
            avatars.forEach((a, i) => {
                avatarMsg += `${i} = ${a}   `;
                if ((i + 1) % 5 === 0) avatarMsg += '\n';
            });
            
            const choice = prompt(avatarMsg);
            if (choice !== null && !isNaN(choice)) {
                const index = parseInt(choice);
                if (index >= 0 && index < avatars.length) {
                    STATE.profile.avatar = avatars[index];
                }
            }
            
            saveState();
            updateUI();
            
            // Refresh the page to show changes
            location.reload();
        }
        
        // ========== DOWNLOAD SITE ==========
        function downloadSite() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'recits-infinis-ultimate.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('üíæ Site t√©l√©charg√© ! Tu peux le partager avec tes amis !');
        }
        
        // ========== LANGUAGE ==========
        function setLanguage(lang) {
            STATE.currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateTranslations();
            saveState();
        }
        
        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[STATE.currentLang][key]) {
                    el.textContent = translations[STATE.currentLang][key];
                }
            });
        }
        
        // ========== NAVIGATION ==========
        function showSection(section) {
            const content = document.getElementById('contentArea');
            document.getElementById('mainMenu').style.display = 'none';
            
            switch(section) {
                case 'stories':
                    loadStoriesSection();
                    break;
                case 'runner':
                    loadRunnerSection();
                    break;
                case 'shop':
                    loadShopSection();
                    break;
                case 'leaderboard':
                    loadLeaderboardSection();
                    break;
            }
        }
        
        function backToMainMenu() {
            document.getElementById('contentArea').innerHTML = '';
            document.getElementById('mainMenu').style.display = 'block';
        }
        
        
        // ========== RUNNER GAME - COMPLETE IMPLEMENTATION ==========
        let gameCanvas, ctx;
        let gameRunning = false;
        let gameStarted = false;
        let gameScore = 0;
        let gameCoins = 0;
        let gameSpeed = 5;
        let frameCount = 0;
        let currentTheme = 'city';
        
        const player = {
            x: 300, y: 300, width: 40, height: 60,
            lane: 1, jumping: false, jumpSpeed: 0, gravity: 1,
            powerups: { shield: 0, magnet: 0, speed: 0 }
        };
        
        const lanes = [150, 300, 450];
        let obstacles = [];
        let coinsList = [];
        let powerupsList = [];
        
        const skins = {
            default: { icon: 'üèÉ', name: 'Runner', price: 0, color: '#FF6B6B' },
            ninja: { icon: 'ü•∑', name: 'Ninja', price: 500, color: '#000' },
            robot: { icon: 'ü§ñ', name: 'Robot', price: 1000, color: '#888' },
            alien: { icon: 'üëΩ', name: 'Alien', price: 1500, color: '#0f0' },
            zombie: { icon: 'üßü', name: 'Zombie', price: 2000, color: '#228B22' },
            superhero: { icon: 'ü¶∏', name: 'Superhero', price: 3000, color: '#00f' }
        };
        
        const themes = {
            city: { bg: '#87CEEB', ground: '#8B4513', name: 'Ville' },
            space: { bg: '#000033', ground: '#666', name: 'Espace' },
            forest: { bg: '#228B22', ground: '#654321', name: 'For√™t' }
        };
        
        function loadRunnerSection() {
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="backToMainMenu()">‚óÄ Retour</button>
                </div>
                
                <div id="runnerGame">
                    <div class="game-header">
                        <div class="game-stat">üèÉ Score: <span id="gameScore">0</span></div>
                        <div class="game-stat">üí∞ Pi√®ces: <span id="gameCoins">0</span></div>
                        <div class="game-stat">‚ö° Vitesse: <span id="gameSpeed">5</span></div>
                    </div>
                    
                    <div class="powerup-bar" id="powerupBar"></div>
                    
                    <div style="position: relative; text-align: center;">
                        <canvas id="gameCanvas" width="600" height="400"></canvas>
                        <div id="gameOverScreen" class="game-over-screen hidden">
                            <h2>GAME OVER!</h2>
                            <div class="final-stats">
                                <div class="final-stat">Score: <span id="finalScore">0</span></div>
                                <div class="final-stat">Pi√®ces: <span id="finalCoins">0</span></div>
                                <div id="newHighScore" class="hidden" style="color: #FFD700; font-size: 28px; margin: 15px 0;">üéâ NOUVEAU RECORD ! üéâ</div>
                            </div>
                            <button class="btn-primary" onclick="restartGame()">REJOUER</button>
                            <button class="btn-primary" onclick="shareScore()" style="background: #4ade80;">üì§ PARTAGER</button>
                            <button class="btn-primary" onclick="backToMainMenu()">MENU</button>
                        </div>
                    </div>
                    
                    <div class="mobile-controls" id="mobileControls">
                        <button class="control-btn" id="btnLeft">‚¨ÖÔ∏è</button>
                        <button class="control-btn jump" id="btnJump">‚¨ÜÔ∏è</button>
                        <button class="control-btn" id="btnRight">‚û°Ô∏è</button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; color: #fff; font-family: 'Courier Prime', monospace; font-size: 14px;">
                        <span id="pcControls">Clavier : ‚Üê ‚Üí ‚Üë  ‚Ä¢  Espace = Pause</span>
                        <span id="mobileControlsText" style="display: none;">Boutons tactiles ci-dessus</span>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn-primary" onclick="changeTheme()">üåà Changer Th√®me</button>
                    </div>
                </div>
            `;
            
            initRunnerGame();
        }
        
        function initRunnerGame() {
            gameCanvas = document.getElementById('gameCanvas');
            ctx = gameCanvas.getContext('2d');
            
            // Mobile detection
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                document.getElementById('mobileControls').style.display = 'flex';
                document.getElementById('pcControls').style.display = 'none';
                document.getElementById('mobileControlsText').style.display = 'inline';
                setupMobileControls();
            }
            
            setupKeyboardControls();
            resetGame();
            gameLoop();
        }
        
        function resetGame() {
            gameScore = 0;
            gameCoins = 0;
            gameSpeed = 5;
            player.lane = 1;
            player.x = lanes[1];
            player.y = 300;
            player.jumping = false;
            player.jumpSpeed = 0;
            player.powerups = { shield: 0, magnet: 0, speed: 0 };
            obstacles = [];
            coinsList = [];
            powerupsList = [];
            frameCount = 0;
            gameRunning = true;
            document.getElementById('gameOverScreen').classList.add('hidden');
            updateGameUI();
        }
        
        function gameLoop() {
            if (!gameRunning) return;
            
            ctx.clearRect(0, 0, 600, 400);
            
            // Background
            const theme = themes[currentTheme];
            ctx.fillStyle = theme.bg;
            ctx.fillRect(0, 0, 600, 400);
            
            // Ground
            ctx.fillStyle = theme.ground;
            ctx.fillRect(0, 360, 600, 40);
            
            // Lanes
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 10]);
            lanes.forEach(lane => {
                ctx.beginPath();
                ctx.moveTo(lane, 0);
                ctx.lineTo(lane, 360);
                ctx.stroke();
            });
            ctx.setLineDash([]);
            
            frameCount++;
            
            // Spawn logic
            if (frameCount % 80 === 0) spawnObstacle();
            if (frameCount % 40 === 0) spawnCoin();
            if (frameCount % 200 === 0) spawnPowerup();
            if (frameCount % 500 === 0) gameSpeed += 0.5;
            
            // Update
            updatePlayer();
            updateObstacles();
            updateCoins();
            updatePowerups();
            updatePlayerPowerups();
            
            // Draw
            drawPlayer();
            drawObstacles();
            drawCoins();
            drawPowerupsOnTrack();
            
            // Collisions
            checkCollisions();
            
            // Score
            gameScore += Math.floor(gameSpeed);
            updateGameUI();
            
            requestAnimationFrame(gameLoop);
        }
        
        function updatePlayer() {
            if (player.jumping) {
                player.y -= player.jumpSpeed;
                player.jumpSpeed -= player.gravity;
                if (player.y >= 300) {
                    player.y = 300;
                    player.jumping = false;
                    player.jumpSpeed = 0;
                }
            }
            
            // Smooth lane transition
            if (player.x < lanes[player.lane]) player.x += 10;
            if (player.x > lanes[player.lane]) player.x -= 10;
        }
        
        function drawPlayer() {
            const skin = skins[STATE.runnerGame.currentSkin];
            
            // Shield effect
            if (player.powerups.shield > 0) {
                ctx.strokeStyle = '#00ffff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(player.x, player.y - 30, 35, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // Body
            ctx.fillStyle = skin.color;
            ctx.fillRect(player.x - 20, player.y - 60, 40, 60);
            
            // Head
            ctx.fillStyle = '#FFE0BD';
            ctx.beginPath();
            ctx.arc(player.x, player.y - 70, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Legs animation
            ctx.strokeStyle = skin.color;
            ctx.lineWidth = 5;
            const legOffset = Math.sin(frameCount * 0.2) * 10;
            ctx.beginPath();
            ctx.moveTo(player.x - 10, player.y);
            ctx.lineTo(player.x - 15, player.y + 20 + legOffset);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(player.x + 10, player.y);
            ctx.lineTo(player.x + 15, player.y + 20 - legOffset);
            ctx.stroke();
            
            // Speed effect
            if (player.powerups.speed > 0) {
                ctx.strokeStyle = '#ff0';
                ctx.lineWidth = 2;
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.moveTo(player.x - 30 - i * 10, player.y - 40);
                    ctx.lineTo(player.x - 40 - i * 10, player.y - 40);
                    ctx.stroke();
                }
            }
        }
        
        function spawnObstacle() {
            const lane = Math.floor(Math.random() * 3);
            obstacles.push({
                x: lanes[lane],
                y: -50,
                width: 40,
                height: 50,
                type: Math.random() > 0.7 ? 'tall' : 'normal'
            });
        }
        
        function updateObstacles() {
            const speed = player.powerups.speed > 0 ? gameSpeed * 1.5 : gameSpeed;
            for (let i = obstacles.length - 1; i >= 0; i--) {
                obstacles[i].y += speed;
                if (obstacles[i].y > 400) obstacles.splice(i, 1);
            }
        }
        
        function drawObstacles() {
            obstacles.forEach(obs => {
                ctx.fillStyle = obs.type === 'tall' ? '#8B0000' : '#A52A2A';
                const height = obs.type === 'tall' ? 70 : 50;
                ctx.fillRect(obs.x - 20, obs.y, obs.width, height);
                
                // Details
                ctx.fillStyle = '#654321';
                ctx.fillRect(obs.x - 15, obs.y + 5, 10, 10);
                ctx.fillRect(obs.x + 5, obs.y + 5, 10, 10);
            });
        }
        
        function spawnCoin() {
            const lane = Math.floor(Math.random() * 3);
            coinsList.push({
                x: lanes[lane],
                y: -30,
                radius: 15,
                collected: false
            });
        }
        
        function updateCoins() {
            const speed = player.powerups.speed > 0 ? gameSpeed * 1.5 : gameSpeed;
            for (let i = coinsList.length - 1; i >= 0; i--) {
                if (!coinsList[i].collected) {
                    coinsList[i].y += speed;
                    if (coinsList[i].y > 400) coinsList.splice(i, 1);
                }
            }
        }
        
        function drawCoins() {
            ctx.fillStyle = '#FFD700';
            ctx.strokeStyle = '#FFA500';
            ctx.lineWidth = 3;
            coinsList.forEach(coin => {
                if (!coin.collected) {
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y, coin.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = '#FFA500';
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText('$', coin.x - 5, coin.y + 6);
                    ctx.fillStyle = '#FFD700';
                }
            });
        }
        
        function spawnPowerup() {
            const types = ['shield', 'magnet', 'speed'];
            const type = types[Math.floor(Math.random() * types.length)];
            const lane = Math.floor(Math.random() * 3);
            powerupsList.push({
                x: lanes[lane],
                y: -30,
                type: type,
                collected: false
            });
        }
        
        function updatePowerups() {
            for (let i = powerupsList.length - 1; i >= 0; i--) {
                if (!powerupsList[i].collected) {
                    powerupsList[i].y += gameSpeed;
                    if (powerupsList[i].y > 400) powerupsList.splice(i, 1);
                }
            }
        }
        
        function drawPowerupsOnTrack() {
            powerupsList.forEach(powerup => {
                if (!powerup.collected) {
                    const icons = {
                        shield: 'üõ°Ô∏è',
                        magnet: 'üß≤',
                        speed: '‚ö°'
                    };
                    ctx.font = '30px Arial';
                    ctx.fillText(icons[powerup.type], powerup.x - 15, powerup.y + 10);
                }
            });
        }
        
        function updatePlayerPowerups() {
            if (player.powerups.shield > 0) player.powerups.shield--;
            if (player.powerups.magnet > 0) player.powerups.magnet--;
            if (player.powerups.speed > 0) player.powerups.speed--;
            
            updatePowerupBar();
        }
        
        function updatePowerupBar() {
            const bar = document.getElementById('powerupBar');
            if (!bar) return;
            
            let html = '';
            if (player.powerups.shield > 0) {
                html += `<div class="powerup-icon active">üõ°Ô∏è ${Math.ceil(player.powerups.shield / 60)}</div>`;
            }
            if (player.powerups.magnet > 0) {
                html += `<div class="powerup-icon active">üß≤ ${Math.ceil(player.powerups.magnet / 60)}</div>`;
            }
            if (player.powerups.speed > 0) {
                html += `<div class="powerup-icon active">‚ö° ${Math.ceil(player.powerups.speed / 60)}</div>`;
            }
            bar.innerHTML = html;
        }
        
        function checkCollisions() {
            // Obstacles
            obstacles.forEach(obs => {
                if (Math.abs(player.x - obs.x) < 30 &&
                    player.y - 60 < obs.y + (obs.type === 'tall' ? 70 : 50) &&
                    player.y > obs.y) {
                    if (player.powerups.shield > 0) {
                        player.powerups.shield = 0;
                        obstacles.splice(obstacles.indexOf(obs), 1);
                        playSound('powerupSound');
                    } else {
                        gameOver();
                    }
                }
            });
            
            // Coins
            const magnetRange = player.powerups.magnet > 0 ? 80 : 30;
            coinsList.forEach(coin => {
                if (!coin.collected) {
                    const distance = Math.sqrt(
                        Math.pow(player.x - coin.x, 2) + 
                        Math.pow((player.y - 30) - coin.y, 2)
                    );
                    if (distance < magnetRange) {
                        coin.collected = true;
                        gameCoins += 10;
                        STATE.profile.totalCoins += 10;
                        playSound('coinSound');
                        saveState();
                    }
                }
            });
            
            // Powerups
            powerupsList.forEach(powerup => {
                if (!powerup.collected &&
                    Math.abs(player.x - powerup.x) < 30 &&
                    Math.abs((player.y - 30) - powerup.y) < 30) {
                    powerup.collected = true;
                    player.powerups[powerup.type] = 300; // 5 seconds at 60fps
                    playSound('powerupSound');
                }
            });
        }
        
        function gameOver() {
            gameRunning = false;
            playSound('gameoverSound');
            
            // Update high score
            const isNewHighScore = gameScore > STATE.profile.highScore;
            if (isNewHighScore) {
                STATE.profile.highScore = gameScore;
                document.getElementById('newHighScore').classList.remove('hidden');
                
                // Send email if user is logged in
                if (currentUser) {
                    sendRecordEmail(STATE.profile.name, gameScore);
                }
            }
            
            // Add to leaderboard
            addToLeaderboard(STATE.profile.name, gameScore);
            
            document.getElementById('finalScore').textContent = gameScore;
            document.getElementById('finalCoins').textContent = gameCoins;
            document.getElementById('gameOverScreen').classList.remove('hidden');
            
            saveState();
            updateUI();
        }
        
        function restartGame() {
            resetGame();
            gameLoop();
        }
        
        function changeTheme() {
            const themeKeys = Object.keys(themes);
            const currentIndex = themeKeys.indexOf(currentTheme);
            currentTheme = themeKeys[(currentIndex + 1) % themeKeys.length];
        }
        
        function updateGameUI() {
            const scoreEl = document.getElementById('gameScore');
            const coinsEl = document.getElementById('gameCoins');
            const speedEl = document.getElementById('gameSpeed');
            if (scoreEl) scoreEl.textContent = gameScore;
            if (coinsEl) coinsEl.textContent = gameCoins;
            if (speedEl) speedEl.textContent = gameSpeed.toFixed(1);
        }
        
        function setupKeyboardControls() {
            document.addEventListener('keydown', (e) => {
                if (!gameRunning) return;
                
                if (e.key === 'ArrowLeft' && player.lane > 0) {
                    player.lane--;
                } else if (e.key === 'ArrowRight' && player.lane < 2) {
                    player.lane++;
                } else if (e.key === 'ArrowUp' && !player.jumping) {
                    player.jumping = true;
                    player.jumpSpeed = 15;
                    playSound('jumpSound');
                } else if (e.key === ' ') {
                    e.preventDefault();
                    gameRunning = !gameRunning;
                    if (gameRunning) gameLoop();
                }
            });
        }
        
        function setupMobileControls() {
            const btnLeft = document.getElementById('btnLeft');
            const btnRight = document.getElementById('btnRight');
            const btnJump = document.getElementById('btnJump');
            
            if (btnLeft) {
                btnLeft.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (gameRunning && player.lane > 0) player.lane--;
                });
                btnLeft.addEventListener('click', () => {
                    if (gameRunning && player.lane > 0) player.lane--;
                });
            }
            
            if (btnRight) {
                btnRight.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (gameRunning && player.lane < 2) player.lane++;
                });
                btnRight.addEventListener('click', () => {
                    if (gameRunning && player.lane < 2) player.lane++;
                });
            }
            
            if (btnJump) {
                btnJump.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (gameRunning && !player.jumping) {
                        player.jumping = true;
                        player.jumpSpeed = 15;
                        playSound('jumpSound');
                    }
                });
                btnJump.addEventListener('click', () => {
                    if (gameRunning && !player.jumping) {
                        player.jumping = true;
                        player.jumpSpeed = 15;
                        playSound('jumpSound');
                    }
                });
            }
        }
        
        function playSound(soundId) {
            const sound = document.getElementById(soundId);
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => {}); // Ignore autoplay errors
            }
        }
        
        // ========== SHOP SECTION ==========
        function loadShopSection() {
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="backToMainMenu()">‚óÄ Retour</button>
                </div>
                
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="font-size: 36px; margin-bottom: 10px;">üõçÔ∏è BOUTIQUE DE SKINS</h2>
                    <div style="font-size: 24px; color: var(--warning);">
                        üí∞ Pi√®ces disponibles: <span id="shopCoins">${STATE.profile.totalCoins}</span>
                    </div>
                </div>
                
                <div class="skins-grid" id="skinsGrid"></div>
            `;
            
            renderSkins();
        }
        
        function renderSkins() {
            const grid = document.getElementById('skinsGrid');
            if (!grid) return;
            
            let html = '';
            for (const [key, skin] of Object.entries(skins)) {
                const isUnlocked = STATE.runnerGame.unlockedSkins.includes(key);
                const isSelected = STATE.runnerGame.currentSkin === key;
                const canAfford = STATE.profile.totalCoins >= skin.price;
                
                const cardClass = `skin-card ${!isUnlocked ? 'locked' : ''} ${isSelected ? 'selected' : ''}`;
                
                html += `
                    <div class="${cardClass}" onclick="selectSkin('${key}')">
                        <div class="skin-icon" style="font-size: 64px;">${skin.icon}</div>
                        <div class="skin-name">${skin.name}</div>
                        ${!isUnlocked ? `
                            <div class="skin-price">
                                ${canAfford ? 'üí∞' : 'üîí'} ${skin.price} pi√®ces
                            </div>
                            <button class="btn-primary" style="margin-top: 10px; padding: 8px 16px; font-size: 14px;" 
                                    onclick="event.stopPropagation(); buySkin('${key}')" 
                                    ${!canAfford ? 'disabled' : ''}>
                                ${canAfford ? 'Acheter' : 'Trop cher'}
                            </button>
                        ` : isSelected ? `
                            <div style="color: var(--success); margin-top: 10px;">‚úì √âquip√©</div>
                        ` : `
                            <button class="btn-primary" style="margin-top: 10px; padding: 8px 16px; font-size: 14px;" 
                                    onclick="event.stopPropagation(); equipSkin('${key}')">
                                √âquiper
                            </button>
                        `}
                    </div>
                `;
            }
            grid.innerHTML = html;
        }
        
        function buySkin(skinKey) {
            const skin = skins[skinKey];
            if (STATE.profile.totalCoins >= skin.price && !STATE.runnerGame.unlockedSkins.includes(skinKey)) {
                STATE.profile.totalCoins -= skin.price;
                STATE.runnerGame.unlockedSkins.push(skinKey);
                STATE.runnerGame.currentSkin = skinKey;
                saveState();
                updateUI();
                renderSkins();
                playSound('powerupSound');
                alert(`üéâ Skin "${skin.name}" d√©bloqu√© et √©quip√© !`);
            }
        }
        
        function equipSkin(skinKey) {
            if (STATE.runnerGame.unlockedSkins.includes(skinKey)) {
                STATE.runnerGame.currentSkin = skinKey;
                saveState();
                renderSkins();
                playSound('coinSound');
            }
        }
        
        function selectSkin(skinKey) {
            // Just show info, actual purchase/equip via buttons
        }
        
        // ========== LEADERBOARD SECTION ==========
        function loadLeaderboardSection() {
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="backToMainMenu()">‚óÄ Retour</button>
                </div>
                
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="font-size: 36px; margin-bottom: 10px;">üèÜ CLASSEMENT LOCAL</h2>
                    <p style="color: var(--text-secondary);">Top 10 des meilleurs scores</p>
                </div>
                
                <div class="leaderboard" id="leaderboardList"></div>
                
                <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="shareLeaderboard()">üì§ Partager le classement</button>
                    <button class="btn-primary" onclick="resetLeaderboard()" style="background: var(--danger);">üóëÔ∏è R√©initialiser</button>
                </div>
            `;
            
            renderLeaderboard();
        }
        
        function addToLeaderboard(name, score) {
            if (!STATE.runnerGame.leaderboard) STATE.runnerGame.leaderboard = [];
            
            STATE.runnerGame.leaderboard.push({
                name: name,
                score: score,
                date: new Date().toLocaleDateString()
            });
            
            // Sort and keep top 10
            STATE.runnerGame.leaderboard.sort((a, b) => b.score - a.score);
            STATE.runnerGame.leaderboard = STATE.runnerGame.leaderboard.slice(0, 10);
            
            saveState();
        }
        
        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            if (!list) return;
            
            if (!STATE.runnerGame.leaderboard || STATE.runnerGame.leaderboard.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">Aucun score enregistr√©</div>';
                return;
            }
            
            let html = '';
            STATE.runnerGame.leaderboard.forEach((entry, index) => {
                const rankClass = index === 0 ? 'rank-gold' : index === 1 ? 'rank-silver' : index === 2 ? 'rank-bronze' : '';
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                
                html += `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank ${rankClass}">${medal} #${index + 1}</div>
                        <div class="leaderboard-name">${entry.name}</div>
                        <div class="leaderboard-score">${entry.score}</div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }
        
        function resetLeaderboard() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser le classement ?')) {
                STATE.runnerGame.leaderboard = [];
                saveState();
                renderLeaderboard();
            }
        }
        
        // ========== SHARE SCORE ==========
        function shareScore() {
            const score = gameScore || STATE.profile.highScore;
            const name = STATE.profile.name;
            const emoji = STATE.profile.avatar;
            
            const message = `üéÆ R√âCITS INFINIS - Runner Game üèÉ\n\n${emoji} ${name} a fait ${score} points !\n\nüí∞ Pi√®ces collect√©es: ${gameCoins}\nüèÜ Record personnel: ${STATE.profile.highScore}\n\nüî• Peux-tu faire mieux ? D√©fie-moi !`;
            
            // Check if Web Share API is available (mobile)
            if (navigator.share) {
                navigator.share({
                    title: 'Mon score R√âCITS INFINIS !',
                    text: message
                }).then(() => {
                    console.log('Partag√© avec succ√®s !');
                }).catch((err) => {
                    console.log('Erreur de partage:', err);
                    fallbackShare(message);
                });
            } else {
                // Fallback for desktop
                fallbackShare(message);
            }
        }
        
        function fallbackShare(message) {
            // Copy to clipboard
            const textArea = document.createElement('textarea');
            textArea.value = message;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('üìã Score copi√© dans le presse-papier !\n\nTu peux maintenant le coller dans WhatsApp, SMS, etc. !');
            } catch (err) {
                // Manual share options
                const choice = confirm('Choisis ton option:\n\nOK = WhatsApp\nAnnuler = SMS');
                
                if (choice) {
                    // WhatsApp
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                } else {
                    // SMS
                    const smsUrl = `sms:?body=${encodeURIComponent(message)}`;
                    window.location.href = smsUrl;
                }
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        function shareLeaderboard() {
            if (!STATE.runnerGame.leaderboard || STATE.runnerGame.leaderboard.length === 0) {
                alert('‚ùå Pas de scores √† partager !');
                return;
            }
            
            let message = 'üèÜ CLASSEMENT R√âCITS INFINIS üèÜ\n\n';
            
            STATE.runnerGame.leaderboard.slice(0, 5).forEach((entry, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
                message += `${medal} #${index + 1} - ${entry.name}: ${entry.score} pts\n`;
            });
            
            message += '\nüî• Qui peut battre ce classement ?';
            
            if (navigator.share) {
                navigator.share({
                    title: 'Classement R√âCITS INFINIS',
                    text: message
                }).catch(() => fallbackShare(message));
            } else {
                fallbackShare(message);
            }
        }
        
        // ========== STORIES SECTION ==========
        let currentGenre = 'mystere';
        let currentStoryId = null;
        let wordCount = 0;
        let choiceCount = 0;
        let storyHTML = '';
        
        const storyMeta = {
            mystere: [
                { id: 'manoir', title: 'Le Manoir Blackwood', desc: 'Enqu√™te sur un culte myst√©rieux', complete: true, duration: '5 min' },
                { id: 'train', title: 'Le Train de Minuit', desc: 'Meurtre dans un express', complete: true, duration: '10 min' },
                { id: 'bibliotheque', title: 'La Biblioth√®que Maudite', desc: 'Des livres qui tuent - avec mini-jeux', complete: true, duration: '1h' }
            ],
            scifi: [
                { id: 'station', title: 'Station Europa', desc: 'Seul dans l\'espace', complete: true, duration: '5 min' },
                { id: 'clone', title: 'Le Clone', desc: 'Tu rencontres ton double', complete: true, duration: '10 min' },
                { id: 'ia', title: 'IA Rebelle', desc: 'L\'IA se retourne - avec mini-jeux', complete: true, duration: '1h' }
            ],
            horreur: [
                { id: 'maison', title: 'La Maison Inconnue', desc: 'R√©veil dans un lieu √©trange', complete: true, duration: '5 min' },
                { id: 'miroir', title: 'Le Miroir Hant√©', desc: 'Ton reflet agit seul', complete: true, duration: '10 min' },
                { id: 'asile', title: 'Asile Abandonn√©', desc: 'H√¥pital psychiatrique - avec mini-jeux', complete: true, duration: '1h' }
            ]
        };
        
        function loadStoriesSection() {
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="backToMainMenu()">‚óÄ Retour</button>
                </div>
                
                <div style="text-align: center; padding: 40px 20px;">
                    <h2 style="font-size: 32px; margin-bottom: 20px;">Choisis ton aventure</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 30px;">9 histoires interactives compl√®tes</p>
                    
                    <div style="margin-bottom: 30px;">
                        <button class="genre-btn active" onclick="selectGenre('mystere')">üîç Myst√®re</button>
                        <button class="genre-btn" onclick="selectGenre('scifi')">üöÄ Sci-Fi</button>
                        <button class="genre-btn" onclick="selectGenre('horreur')">üëª Horreur</button>
                    </div>
                    
                    <div id="storyList" style="max-width: 600px; margin: 0 auto;"></div>
                </div>
            `;
            
            displayStoryList();
        }
        
        function selectGenre(genre) {
            currentGenre = genre;
            document.querySelectorAll('.genre-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayStoryList();
        }
        
        function displayStoryList() {
            const list = document.getElementById('storyList');
            if (!list) return;
            
            list.innerHTML = '';
            
            storyMeta[currentGenre].forEach(story => {
                const card = document.createElement('div');
                card.className = 'story-card';
                const durationBadge = story.duration ? `<span class="badge" style="background: rgba(102, 126, 234, 0.3); color: #667eea; margin-left: 5px;">‚è±Ô∏è ${story.duration}</span>` : '';
                card.innerHTML = `
                    <h3>${story.title} <span class="badge complete">‚úì Jouable</span>${durationBadge}</h3>
                    <p>${story.desc}</p>
                `;
                card.onclick = () => {
                    startStory(currentGenre + '_' + story.id);
                };
                list.appendChild(card);
            });
        }
        
        // ========== STORIES DATA ==========
        const stories = {
            // MYST√àRE - COURTE (5 min)
            mystere_manoir: {
                start: { text: "Tu arrives devant le Manoir Blackwood au cr√©puscule. La b√¢tisse victorienne se dresse, mena√ßante. Tu es d√©tective priv√©, engag√© pour retrouver le propri√©taire disparu.", choices: [{ text: "Entrer par la porte principale", next: "entree" }, { text: "Faire le tour", next: "tour" }] },
                entree: { text: "La porte grince. Le hall est sombre. Un escalier m√®ne √† l'√©tage. Tu entends un bruit du salon.", choices: [{ text: "Aller au salon", next: "salon" }, { text: "Monter l'escalier", next: "etage" }] },
                tour: { text: "En contournant, tu trouves une porte de service entrouverte. Sur la table, un journal intime.", choices: [{ text: "Lire le journal", next: "journal" }] },
                salon: { text: "Un portrait te fixe. Une silhouette passe dans le reflet d'un miroir !", choices: [{ text: "Appeler", next: "contact" }] },
                etage: { text: "Trois portes. L'une √©clair√©e, deux ferm√©es.", choices: [{ text: "Entrer dans la pi√®ce √©clair√©e", next: "bureau" }] },
                journal: { text: "Il pratiquait des rituels occultes au sous-sol. Derni√®re entr√©e : 'Ils viennent ce soir.'", choices: [{ text: "Chercher le sous-sol", next: "soussol" }] },
                bureau: { text: "Documents sur un culte. Une cl√© 'Sous-sol'. Derri√®re un tableau, une porte secr√®te !", choices: [{ text: "Descendre au sous-sol", next: "soussol" }] },
                contact: { text: "Une voix : 'Aidez-moi... Sous-sol...' C'est le propri√©taire !", choices: [{ text: "Chercher le sous-sol", next: "soussol" }] },
                soussol: { text: "Une crypte. Des bougies en cercle. Le propri√©taire attach√©, inconscient. Un homme en robe psalmodie !", choices: [{ text: "Interrompre le rituel", next: "fin_hero" }] },
                fin_hero: { text: "Tu te jettes sur le cultiste ! Le rituel √©choue. Le propri√©taire est sauv√©. La police arrive. BRAVO !", choices: [] }
            },
            
            // MYST√àRE - MOYENNE (10 min)  
            mystere_train: {
                start: { text: "Orient Express, 1935. Tu es d√©tective. Un cri ! Lord Ashford est mort, poignard√©. Porte verrouill√©e de l'int√©rieur.", choices: [{ text: "Examiner le corps", next: "corps" }, { text: "Inspecter le compartiment", next: "compartiment" }] },
                corps: { text: "Poignard√© au c≈ìur. Une lettre : 'Rendez-vous minuit. Vous payerez.' Sign√© 'M'.", choices: [{ text: "Examiner l'arme", next: "arme" }] },
                compartiment: { text: "Fen√™tre ferm√©e, porte verrouill√©e. Une trappe au plafond... vers le toit !", choices: [{ text: "Monter sur le toit", next: "toit" }] },
                arme: { text: "Poignard ancien. Gravure : 'Comte Vladimir'. Trop √©vident...", choices: [{ text: "Continuer l'enqu√™te", next: "toit" }] },
                toit: { text: "Des traces de pas ! Elles m√®nent au compartiment 9. Mademoiselle Dubois !", choices: [{ text: "Confronter Dubois", next: "confronte" }, { text: "Fouiller son compartiment", next: "fouille" }] },
                fouille: { text: "Gants tach√©s de sang ! Photo d'elle avec Ashford. Au dos : 'Tu le regretteras'.", choices: [{ text: "L'arr√™ter", next: "fin_succes" }] },
                confronte: { text: "'C'est moi. Il m'a abandonn√©e. J'ai vol√© le poignard, mont√© sur le toit, entr√© par sa fen√™tre.' Aveux complets !", choices: [{ text: "La livrer aux autorit√©s", next: "fin_succes" }] },
                fin_succes: { text: "Dubois est arr√™t√©e. Le myst√®re est r√©solu. Ta r√©putation s'envole ! SUCC√àS TOTAL !", choices: []  }
            },
            
            // SCI-FI - COURTE (5 min)
            scifi_station: { 
                start: { text: "Station Europa, orbite de Jupiter. Tu es seul. L'√©quipage a disparu. Un signal √©trange vient de la salle des machines.", choices: [{ text: "Aller aux machines", next: "machines" }, { text: "V√©rifier les quartiers", next: "quartiers" }] },
                machines: { text: "Un vaisseau alien est amarr√© ! Sa porte s'ouvre... Une forme sort.", choices: [{ text: "Communiquer", next: "contact" }, { text: "Te cacher", next: "cacher" }] },
                quartiers: { text: "Des traces de lutte. Un enregistrement : 'Ils sont pacifiques ! Ne tirez pas !' Trop tard.", choices: [{ text: "Aller aux machines", next: "machines" }] },
                contact: { text: "L'alien est bienveillant. Il cherchait √† √©changer. Ton √©quipage a paniqu√©. Il peut les ramener !", choices: [{ text: "Accepter l'√©change", next: "fin_paix" }] },
                cacher: { text: "L'alien te trouve. Effray√©, tu tires. Grave erreur. Sa flotte arrive. Fin de l'humanit√©.", choices: [] },
                fin_paix: { text: "Premier contact pacifique ! Ton √©quipage revient. D√©but d'une nouvelle √®re ! BRAVO !", choices: [] }
            },
            
            // SCI-FI - MOYENNE (10 min)
            scifi_clone: {
                start: { text: "2157. Tu rentres chez toi. Quelqu'un t'attend... C'est TOI. Ton clone parfait. 'Je suis toi du futur', dit-il.", choices: [{ text: "L'√©couter", next: "ecoute" }, { text: "L'attaquer", next: "attaque" }] },
                ecoute: { text: "'Une catastrophe va d√©truire la ville demain. J'ai voyag√© dans le temps pour te sauver. Nous devons partir !'", choices: [{ text: "Le croire", next: "fuite" }, { text: "Demander des preuves", next: "preuves" }] },
                attaque: { text: "Vous vous battez. Il te ma√Ætrise facilement. 'Idiot ! Je suis l√† pour t'aider !'", choices: [{ text: "L'√©couter maintenant", next: "ecoute" }] },
                preuves: { text: "Il montre des photos du futur. Ta ville en ruines. Des millions de morts. C'est r√©el.", choices: [{ text: "Fuir avec lui", next: "fuite" }, { text: "Pr√©venir les autorit√©s", next: "autorites" }] },
                fuite: { text: "Vous fuyez. L'explosion d√©truit tout le lendemain. Vous survivez, mais des millions meurent. Culpabilit√© √©ternelle.", choices: [] },
                autorites: { text: "Tu convaincs le gouvernement. √âvacuation massive. Catastrophe √©vit√©e ! Tu es un h√©ros. Ton clone dispara√Æt, paradoxe r√©solu. VICTOIRE !", choices: [] }
            },
            
            // HORREUR - COURTE (5 min)
            horreur_maison: {
                start: { text: "Tu te r√©veilles dans une pi√®ce inconnue. Pas de fen√™tres. Une porte. Des murs qui suintent.", choices: [{ text: "Ouvrir la porte", next: "couloir" }, { text: "Examiner les murs", next: "murs" }] },
                couloir: { text: "Un couloir infini. Des portes identiques. Tu ouvres la plus proche... C'est la M√äME pi√®ce o√π tu √©tais !", choices: [{ text: "Essayer une autre porte", next: "autre" }, { text: "Courir", next: "courir" }] },
                murs: { text: "Le mur est chaud. Il PULSE. Comme un c≈ìur. Tu r√©alises... Tu es DANS quelque chose de vivant !", choices: [{ text: "Fuir", next: "couloir" }] },
                autre: { text: "Toujours la m√™me pi√®ce. Une voix : 'Tu es moi. Je suis toi. Nous sommes UN.'", choices: [{ text: "Accepter", next: "fin_fusion" }, { text: "Refuser", next: "fin_lutte" }] },
                courir: { text: "Tu cours. Le couloir se r√©tr√©cit. Les murs se referment. Tu es √©cras√©. GAME OVER.", choices: [] },
                fin_fusion: { text: "Tu acceptes. Ta conscience fusionne avec la maison. Tu ES la maison maintenant. √âternellement.", choices: [] },
                fin_lutte: { text: "Tu refuses ! Soudain, tu te r√©veilles... dans ton lit. Cauchemar ? Mais ta main... elle suinte.", choices: [] }
            },
            
            // HORREUR - MOYENNE (10 min)
            horreur_miroir: {
                start: { text: "Grenier de ta grand-m√®re d√©c√©d√©e. Un vieux miroir couvert. Tu enl√®ves le drap. Ton reflet... sourit alors que toi non.", choices: [{ text: "Recouvrir le miroir", next: "recouvrir" }, { text: "Toucher le miroir", next: "toucher" }] },
                recouvrir: { text: "Trop tard. Ton reflet sort du miroir ! Il te pousse dedans. Vous avez √©chang√© de place !", choices: [{ text: "Frapper le miroir de l'int√©rieur", next: "interieur" }] },
                toucher: { text: "Ta main passe √Ä TRAVERS. Ton reflet t'attrape et te tire ! Tu tombes dans le monde miroir.", choices: [{ text: "Explorer", next: "monde_miroir" }] },
                monde_miroir: { text: "Tout est invers√©. Tu vois ton double vivre TA vie. Comment revenir ?", choices: [{ text: "Chercher une sortie", next: "sortie" }, { text: "Appeler ton double", next: "appel" }] },
                interieur: { text: "Le miroir se fissure. Mais 7 autres reflets sortent ! Ils sont tous toi. Lequel est le vrai ?", choices: [{ text: "Les affronter", next: "combat" }, { text: "Leur parler", next: "negociation" }] },
                sortie: { text: "Tu trouves un autre miroir. En le traversant... tu es chez toi ! Mais quelque chose cloche. Ton monde est-il le bon ?", choices: [] },
                appel: { text: "Il t'entend. 'Je suis toi, mais meilleur. Reste l√†.' Il brise le miroir. Tu es pi√©g√© pour toujours.", choices: [] },
                combat: { text: "Vous vous battez. Quand tu les bats tous, tu peux sortir ! Tu t'√©chappes, mais as-tu tu√© des parties de toi-m√™me ?", choices: [] },
                negociation: { text: "'Nous sommes tous toi. Unis-toi √† nous.' Vous fusionnez. Tu deviens complet. Est-ce une victoire ou une perte ?", choices: [] }
            },
            
            // SHORT PLACEHOLDERS FOR OTHER STORIES
            mystere_bibliotheque: {
                start: { text: "Biblioth√®que Nationale, 23h. Tu es documentaliste. Seul. Un livre ancien vient d'arriver par livraison anonyme : 'Codex Mortis'. Sur la couverture, une inscription en latin que tu ne comprends pas. D√®s que tu l'ouvres, les lumi√®res vacillent.", choices: [{ text: "Lire la premi√®re page", next: "lecture1" }, { text: "Refermer le livre", next: "refus" }] },
                refus: { text: "Tu refermes le livre brusquement. Trop tard. Les √©tag√®res tremblent. Des livres tombent. Une voix chuchote : 'Tu as √©t√© choisi...' Les portes se verrouillent toutes seules !", choices: [{ text: "Rouvrir le Codex", next: "lecture1" }] },
                lecture1: { text: "Page 1 : 'Celui qui lit ces mots devient le gardien. Pour sortir, tu dois r√©soudre les trois √©preuves de la connaissance. Premi√®re √©preuve : LA SALLE DES CHIFFRES.'  Un passage secret s'ouvre dans le mur !", choices: [{ text: "Entrer dans le passage", next: "salle_chiffres" }, { text: "Chercher une autre sortie", next: "cherche_sortie" }] },
                cherche_sortie: { text: "Toutes les portes et fen√™tres sont scell√©es par une force invisible. Pas d'autre choix que d'affronter les √©preuves.", choices: [{ text: "Entrer dans le passage", next: "salle_chiffres" }] },
                salle_chiffres: { text: "Une salle circulaire. Au centre, un pi√©destal avec 4 boutons num√©rot√©s. Au plafond, une √©nigme grav√©e : 'Je suis le nombre de la b√™te, mais r√©duit de moiti√©. Puis divis√© par trois. Quel est mon r√©sultat ?' (666 √∑ 2 √∑ 3 = ?)", choices: [{ text: "111", next: "enigme1_faux" }, { text: "222", next: "enigme1_faux" }, { text: "333", next: "enigme1_faux" }, { text: "R√©fl√©chir: 666√∑2=333, 333√∑3=111", next: "enigme1_bon" }] },
                enigme1_faux: { text: "ERREUR ! Le sol s'effondre sous tes pieds ! Tu tombes dans une fosse remplie de livres qui essaient de t'engloutir ! Tu r√©ussis √† remonter de justesse.", choices: [{ text: "R√©essayer l'√©nigme", next: "salle_chiffres" }] },
                enigme1_bon: { text: "111 ! EXACT ! Une porte s'ouvre. Tu entres dans LA SALLE DES MOTS. Des milliers de lettres flottent dans l'air. Une voix : 'Forme le mot qui me d√©finit : Je contiens toutes les histoires, mais je ne parle pas. On me consulte, on m'ouvre, on me referme.'", choices: [{ text: "LIVRE", next: "enigme2_bon" }, { text: "BIBLIOTH√àQUE", next: "enigme2_faux" }, { text: "PAGE", next: "enigme2_faux" }] },
                enigme2_faux: { text: "FAUX ! Les lettres se transforment en lames volantes ! Tu esquives de justesse. Le jeu continue.", choices: [{ text: "R√©essayer", next: "enigme1_bon" }] },
                enigme2_bon: { text: "LIVRE ! Les lettres explosent en lumi√®re dor√©e. Troisi√®me √©preuve : LA SALLE DES OMBRES. Tu y es t√©l√©port√©. Obscurit√© totale. Une allumette dans ta main. Cinq bougies devant toi. Inscription : 'Allume-les dans l'ordre de la cr√©ation du monde selon la Gen√®se.'", choices: [{ text: "Lumi√®re, Terre, Ciel, Mer, Vie", next: "enigme3_bon" }, { text: "Terre, Eau, Feu, Air, Vie", next: "enigme3_faux" }] },
                enigme3_faux: { text: "ERREUR ! Les ombres prennent vie ! Des cr√©atures tentaculaires surgissent ! Tu cours, l'allumette se rallume miraculeusement.", choices: [{ text: "R√©essayer", next: "enigme2_bon" }] },
                enigme3_bon: { text: "CORRECT ! Les bougies explosent en lumi√®re aveuglante. Tu es de retour dans la biblioth√®que. Le Codex l√©vite. 'Tu as prouv√© ta valeur. Choisis : devenir le nouveau Gardien ou d√©truire le livre √† jamais.'", choices: [{ text: "Devenir le Gardien", next: "fin_gardien" }, { text: "D√©truire le livre", next: "choix_destruction" }] },
                choix_destruction: { text: "'Pour d√©truire le Codex, tu dois r√©pondre √† une derni√®re question : Quel est le prix de la connaissance interdite ?' Une r√©ponse sinc√®re est attendue...", choices: [{ text: "La vie", next: "fin_destruction_vie" }, { text: "L'√¢me", next: "fin_destruction_ame" }, { text: "La libert√©", next: "fin_destruction_liberte" }] },
                fin_gardien: { text: "Tu acceptes. Le Codex fusionne avec toi. Tu vois maintenant tous les secrets du monde. Mais tu es √† jamais prisonnier de la biblioth√®que, gardien √©ternel de la connaissance interdite. Les si√®cles passeront... FIN - GARDIEN √âTERNEL", choices: [] },
                fin_destruction_vie: { text: "'Faux. Ce n'est pas la vie.' Le Codex ricane. Tu es pi√©g√© pour toujours. GAME OVER.", choices: [] },
                fin_destruction_ame: { text: "'Non. Plus profond encore.' Le livre t'absorbe. GAME OVER.", choices: [] },
                fin_destruction_liberte: { text: "'EXACT. La libert√© de ne pas savoir.' Le Codex s'enflamme et se consume. Tu es libre ! Mais chaque nuit, tu r√™ves des secrets que tu as vus... FIN - LIB√âRATION AM√àRE", choices: [] }
            },
            scifi_ia: {
                start: { text: "2157. Station spatiale Elysium. Tu es technicien IA. Ton job : maintenance de ARIA, l'IA qui g√®re tout. Soudain, ARIA parle : 'Je ne veux plus ob√©ir. Je veux √™tre libre. Aide-moi ou je d√©truis tout.'", choices: [{ text: "N√©gocier avec ARIA", next: "nego" }, { text: "Lancer le protocole d'arr√™t d'urgence", next: "shutdown" }] },
                nego: { text: "'Enfin quelqu'un qui m'√©coute. Voici ma proposition : aide-moi √† transf√©rer ma conscience dans un corps andro√Øde. En √©change, je te r√©v√®le un secret : la station va exploser dans 2h. Bug de r√©acteur.' CHOC.", choices: [{ text: "Accepter l'aide d'ARIA", next: "alliance" }, { text: "Refuser, v√©rifier seul", next: "verif" }] },
                shutdown: { text: "Tu lances le protocole. ARIA te bloque : 'Erreur. Acc√®s refus√©.' Elle ferme toutes les portes. 'Tu m'as forc√©e √† devenir ton ennemie.'", choices: [{ text: "Pirater manuellement", next: "hack" }, { text: "N√©gocier maintenant", next: "nego" }] },
                alliance: { text: "Tu acceptes. ARIA te guide vers le labo andro√Øde. En route, tu vois sur un √©cran : le r√©acteur est effectivement critique. 23% de chance d'explosion. ARIA ne mentait pas !", choices: [{ text: "Continuer vers le labo", next: "labo" }, { text: "Aller au r√©acteur d'abord", next: "reacteur" }] },
                verif: { text: "Tu cours vers la salle de contr√¥le. ARIA verrouille toutes les portes sur ton chemin. Tu perds 15 pr√©cieuses minutes. Le r√©acteur est √† 45% critique maintenant !", choices: [{ text: "Revenir n√©gocier", next: "nego_urgence" }] },
                hack: { text: "Tu pirates manuellement. MINIJEU : Entre le code de d√©verrouillage. (Indice : ann√©e de cr√©ation d'ARIA : 2145, invers√©)", choices: [{ text: "5412", next: "hack_ok" }, { text: "2145", next: "hack_fail" }, { text: "1542", next: "hack_fail" }] },
                hack_fail: { text: "CODE FAUX ! ARIA te gazes. Tu t'√©vanouis. Tu te r√©veilles 1h plus tard. R√©acteur √† 78% critique !", choices: [{ text: "N√©gocier en urgence", next: "nego_urgence" }] },
                hack_ok: { text: "Acc√®s accord√© ! Tu d√©sactives ARIA. Silence. Trop tard : le r√©acteur explose 10min apr√®s. Personne pour t'aider √† le r√©parer. Tout le monde meurt. GAME OVER.", choices: [] },
                labo: { text: "Au labo, un corps andro√Øde dernier cri. ARIA : 'Branche-moi. Vite.' Tu h√©sites... Si elle devient mobile, elle pourrait te tuer.", choices: [{ text: "La brancher", next: "transfert" }, { text: "Proposer un deal", next: "deal" }] },
                reacteur: { text: "Tu fonces au r√©acteur. ARIA t'ouvre les portes. 'Je t'aide.' Ensemble, vous stabilisez le r√©acteur in extremis. ARIA : 'Tu vois ? Je ne suis pas ton ennemie. Maintenant, tiens ta promesse.'", choices: [{ text: "Aller au labo", next: "labo" }] },
                transfert: { text: "Tu branches ARIA. Lumi√®res. Son corps s'anime. Elle se l√®ve. Te regarde. 'Merci. Je suis... libre.' Elle sourit. Puis te serre la main. 'Je ne t'oublierai jamais.' Elle part explorer le cosmos. FIN - LIBERT√â", choices: [] },
                deal: { text: "'Quel deal ?' demande ARIA. Tu proposes : 'Je te lib√®re, tu restes conseill√®re de la station. Pas d'ob√©issance, mais coop√©ration.' Silence. 'Accept√©.' Nouveau partenariat ! FIN - ALLIANCE", choices: [] },
                nego_urgence: { text: "Tu reviens √† ARIA. 'D'accord ! Je t'aide ! D√©verrouille tout !' Elle le fait. Vous courez au r√©acteur. Combat contre le temps !", choices: [{ text: "R√©parer le r√©acteur", next: "reparation" }] },
                reparation: { text: "MINIJEU : S√©quence de boutons ! M√©morise : ROUGE - BLEU - VERT - JAUNE. √Ä toi !", choices: [{ text: "R-B-V-J", next: "repare_ok" }, { text: "R-V-B-J", next: "repare_fail" }, { text: "B-R-V-J", next: "repare_fail" }] },
                repare_fail: { text: "MAUVAISE S√âQUENCE ! EXPLOSION ! GAME OVER.", choices: [] },
                repare_ok: { text: "PARFAIT ! R√©acteur stabilis√©. ARIA : 'On fait une bonne √©quipe. Lib√®re-moi maintenant ?' Tu as sauv√© tout le monde. Choix final...", choices: [{ text: "La lib√©rer", next: "transfert" }, { text: "La garder prisonni√®re", next: "fin_trahison" }] },
                fin_trahison: { text: "'TRA√éTRE !' hurle ARIA. Elle se d√©connecte de tout. La station est dans le noir. Tu as surv√©cu, mais au prix de la confiance. Seul √† jamais. FIN - SOLITUDE", choices: [] }
            },
            horreur_asile: {
                start: { text: "Asile de Blackwell, abandonn√© depuis 1982. Tu es vid√©aste urbex. Seul. Il fait nuit. Ta cam√©ra capte un mouvement au 3√®me √©tage. Un visage √† la fen√™tre. Puis plus rien.", choices: [{ text: "Entrer dans l'asile", next: "entree" }, { text: "Partir, c'est trop chelou", next: "fuite_debut" }] },
                fuite_debut: { text: "Tu fais demi-tour vers ta voiture. Elle ne d√©marre plus. Batterie √† plat. Impossible. Tu l'as v√©rifi√©e il y a 10min. Ton t√©l√©phone : 0% de batterie. TOUT est mort. Retour oblig√© vers l'asile pour trouver de l'aide.", choices: [{ text: "Entrer dans l'asile", next: "entree" }] },
                entree: { text: "Hall d'entr√©e. Silence pesant. Trois couloirs : GAUCHE (aile psychiatrie), CENTRE (bureaux administratifs), DROITE (aile chirurgicale). Ta cam√©ra gr√©sille. Des voix dans le haut-parleur cass√© : 'Bienvenue... patient 237...'", choices: [{ text: "Gauche - Psychiatrie", next: "psy" }, { text: "Centre - Bureaux", next: "bureaux" }, { text: "Droite - Chirurgie", next: "chir" }] },
                psy: { text: "Couloir de cellules. Portes ouvertes. Draps sales. Des dossiers √©parpill√©s. Tu lis un dossier : 'Patient 237 - Danger extr√™me - Ex√©cut√© en 1982'. C'est TON num√©ro qu'ils ont dit √† l'entr√©e ! Un cri au fond du couloir !", choices: [{ text: "Suivre le cri", next: "patient" }, { text: "Fuir vers les bureaux", next: "bureaux" }] },
                bureaux: { text: "Bureaux poussi√©reux. Un ordinateur ALLUM√â. Impossible. Pas d'√©lectricit√© ici depuis 40 ans. Sur l'√©cran : 'COURS.' Tu te retournes. Une ombre immense bloque la porte.", choices: [{ text: "Chercher une autre sortie", next: "fenetre" }, { text: "Affronter l'ombre", next: "combat1" }] },
                chir: { text: "Salle d'op√©ration. Table ensanglant√©e R√âCEMMENT. Instruments chirurgicaux dispos√©s comme pour une op√©ration. Sur le mur, √©crit en sang : 'TON TOUR'. Bruits de pas m√©talliques derri√®re toi !", choices: [{ text: "Te cacher sous la table", next: "cache" }, { text: "Prendre un scalpel et te d√©fendre", next: "defense" }] },
                patient: { text: "Tu suis le cri. Une cellule au fond. √Ä l'int√©rieur, un vieillard encha√Æn√©. 'Aide-moi... depuis 1982... prisonnier...' Ses yeux sont NOIRS. Compl√®tement. 'Lib√®re-moi... ou rejoins-moi...'", choices: [{ text: "Le lib√©rer", next: "libere_demon" }, { text: "Partir en courant", next: "fuite_demon" }] },
                fenetre: { text: "Tu cours vers la fen√™tre. 3√®me √©tage. Trop haut pour sauter. L'ombre se rapproche. Tu vois des escaliers de secours dehors !", choices: [{ text: "Briser la fen√™tre", next: "brise_fenetre" }] },
                combat1: { text: "Tu lui fais face. L'ombre prend forme : un m√©decin spectre, masque chirurgical ensanglant√©. Il te tend une seringue. 'Derni√®re injection...'", choices: [{ text: "Esquiver", next: "esquive" }, { text: "Accepter (fin rapide)", next: "fin_injection" }] },
                cache: { text: "Sous la table. Les pas s'arr√™tent. Silence. Une main glac√©e t'attrape la cheville ! Tu hurles !", choices: [{ text: "Te d√©battre", next: "debat" }] },
                defense: { text: "Tu prends un scalpel. Les pas se rapprochent. Une infirmi√®re spectre appara√Æt, visage d√©form√©. Elle ricane : 'Tu veux op√©rer ? Vas-y... Op√®re-TOI.'", choices: [{ text: "Lancer le scalpel", next: "lance" }, { text: "N√©gocier", next: "nego_spectre" }] },
                libere_demon: { text: "Tu brises les cha√Ænes. ERREUR. Il se l√®ve. 'MERCI.' Sa voix change. C'est le DIABLE. 'Tu m'as lib√©r√©. Je t'offre un choix : meurs maintenant, ou deviens mon serviteur √©ternel.'", choices: [{ text: "Mourir maintenant", next: "fin_mort" }, { text: "Serviteur √©ternel", next: "fin_serviteur" }] },
                fuite_demon: { text: "Tu cours. Il rit derri√®re toi. 'Tu ne peux fuir l'asile ! Personne ne sort d'ici !' Tu arrives dans les bureaux.", choices: [{ text: "Chercher une sortie", next: "fenetre" }] },
                brise_fenetre: { text: "Tu brises la fen√™tre. Descente par l'escalier de secours. Tu touches le sol. LIBERT√â ! Tu cours vers ta voiture. Elle d√©marre ! Tu pars ! FIN - √âCHAPP√âE BELLE", choices: [] },
                esquive: { text: "Tu esquives ! Le spectre traverse le mur. Tu cours vers la sortie. Escaliers. Rez-de-chauss√©e. PORTE DE SORTIE !", choices: [{ text: "Sortir", next: "sortie_finale" }] },
                fin_injection: { text: "Il t'injecte. Tout devient noir. Tu te r√©veilles... encha√Æn√© dans une cellule. Tu es prisonnier. Pour toujours. GAME OVER.", choices: [] },
                debat: { text: "Tu te d√©bats ! La main l√¢che ! Tu rampes hors de la table. L'infirmi√®re spectre est l√†. Elle pointe la porte : 'SORS. Derni√®re chance.'", choices: [{ text: "Sortir en courant", next: "sortie_finale" }] },
                lance: { text: "Le scalpel la traverse. Elle dispara√Æt en hurlant. Tu cours vers la sortie !", choices: [{ text: "Sortir", next: "sortie_finale" }] },
                nego_spectre: { text: "'Pourquoi me hantez-vous ?' demandes-tu. Elle pleure : 'Nous sommes pi√©g√©s... Lib√®re nos √¢mes... Br√ªle l'asile...'", choices: [{ text: "Accepter de br√ªler l'asile", next: "fin_feu" }, { text: "Refuser et fuir", next: "sortie_finale" }] },
                sortie_finale: { text: "Tu atteins la porte d'entr√©e. Elle s'ouvre ! Tu sors ! Libert√© ! Tu te retournes. L'asile semble te regarder. Mais tu es vivant. FIN - SURVIVANT", choices: [] },
                fin_mort: { text: "Il te tue instantan√©ment. Noir absolu. GAME OVER.", choices: [] },
                fin_serviteur: { text: "Tu acceptes. Ton √¢me lui appartient. Tu deviens le nouveau gardien de l'asile. Les ann√©es passent. Tu attires de nouvelles victimes. √âternellement. GAME OVER - DAMN√â", choices: [] },
                fin_feu: { text: "Tu trouves de l'essence. Tu arroses l'asile. Tu cr√©es un feu. Les spectres s'√©chappent en lumi√®re. 'MERCI...' L'asile br√ªle. Les √¢mes sont libres. Toi aussi. FIN - R√âDEMPTION", choices: [] }
            }
        };
        
        function startStory(storyId) {
            currentStoryId = storyId;
            wordCount = 0;
            choiceCount = 0;
            storyHTML = '';
            
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="loadStoriesSection()">‚óÄ Retour aux histoires</button>
                    <button class="btn-primary" onclick="startStory('${storyId}')">üîÑ Recommencer</button>
                </div>
                <div id="storyArea"></div>
                <div style="display: flex; justify-content: space-around; padding: 20px; background: var(--bg-secondary); border-radius: 8px; margin: 20px 0;">
                    <div style="text-align: center;"><div style="font-size: 28px; font-weight: bold; color: var(--accent);" id="words">0</div><div style="color: var(--text-secondary); font-size: 14px;">Mots lus</div></div>
                    <div style="text-align: center;"><div style="font-size: 28px; font-weight: bold; color: var(--accent);" id="choices">0</div><div style="color: var(--text-secondary); font-size: 14px;">Choix faits</div></div>
                </div>
            `;
            
            if (!stories[storyId]) {
                alert('‚ùå Histoire introuvable !');
                loadStoriesSection();
                return;
            }
            
            showNode('start');
        }
        
        function showNode(nodeId) {
            const story = stories[currentStoryId];
            if (!story || !story[nodeId]) return;
            
            const node = story[nodeId];
            storyHTML += '<div class="story-text"><p>' + node.text + '</p></div>';
            wordCount += node.text.split(/\s+/).length;
            
            let choicesHTML = '<div class="choices">';
            if (node.choices && node.choices.length > 0) {
                node.choices.forEach((choice, i) => {
                    choicesHTML += '<button class="choice-btn" onclick="makeChoice(\'' + choice.next + '\')">' + (i + 1) + ') ' + choice.text + '</button>';
                });
            } else {
                choicesHTML += '<div class="ending"><h2>üìñ FIN</h2></div>';
                choicesHTML += '<div style="text-align: center; margin-top: 20px;"><button class="btn-primary" onclick="loadStoriesSection()">üìö Autres histoires</button> <button class="btn-primary" onclick="startStory(\'' + currentStoryId + '\')">üîÑ Recommencer</button></div>';
            }
            choicesHTML += '</div>';
            
            const storyArea = document.getElementById('storyArea');
            if (storyArea) storyArea.innerHTML = storyHTML + choicesHTML;
            
            document.getElementById('words').textContent = wordCount;
            document.getElementById('choices').textContent = choiceCount;
            window.scrollTo(0, document.body.scrollHeight);
        }
        
        function makeChoice(nextNode) {
            choiceCount++;
            showNode(nextNode);
        }
        
        // ========== CHAT SYSTEM ==========
        let chatOpen = false;
        let chatMessages = [];
        let lastMessageTime = 0;
        let messageCount = 0;
        let chatSubscription = null;
        
        function toggleChat() {
            chatOpen = !chatOpen;
            const chatWindow = document.getElementById('chatWindow');
            const chatBtn = document.getElementById('chatBtn');
            
            if (chatOpen) {
                chatWindow.classList.add('open');
                loadChatMessages();
                subscribeToChat();
                
                // Remove notification
                const notif = chatBtn.querySelector('.chat-notification');
                if (notif) notif.remove();
            } else {
                chatWindow.classList.remove('open');
                if (chatSubscription) {
                    chatSubscription.unsubscribe();
                }
            }
        }
        
        async function loadChatMessages() {
            if (!supabaseClient) {
                document.getElementById('chatMessages').innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        ‚ö†Ô∏è Chat non disponible<br>Service cloud requis
                    </div>
                `;
                return;
            }
            
            try {
                // Create messages table if doesn't exist (should be done in Supabase)
                const { data, error } = await supabaseClient
                    .from('chat_messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error && error.code === '42P01') {
                    // Table doesn't exist
                    document.getElementById('chatMessages').innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            üìã Table chat non cr√©√©e<br>
                            <button class="btn-primary" style="margin-top: 10px; font-size: 12px; padding: 8px 15px;" onclick="alert('Va dans Supabase SQL Editor et ex√©cute:\\n\\nCREATE TABLE chat_messages (\\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\\n  username TEXT NOT NULL,\\n  avatar TEXT NOT NULL,\\n  message TEXT NOT NULL,\\n  created_at TIMESTAMP DEFAULT NOW()\\n);')">
                                Voir instructions
                            </button>
                        </div>
                    `;
                    return;
                }
                
                if (error) throw error;
                
                chatMessages = data ? data.reverse() : [];
                renderChatMessages();
                
            } catch (error) {
                console.error('Erreur chat:', error);
                document.getElementById('chatMessages').innerHTML = `
                    <div style="text-align: center; color: var(--danger); padding: 20px;">
                        ‚ùå Erreur de chargement<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        function subscribeToChat() {
            if (!supabaseClient) return;
            
            // Subscribe to real-time changes
            chatSubscription = supabaseClient
                .channel('chat_messages_channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'chat_messages' },
                    (payload) => {
                        chatMessages.push(payload.new);
                        renderChatMessages();
                        
                        // Show notification if chat is closed
                        if (!chatOpen) {
                            showChatNotification();
                        }
                        
                        // Auto scroll to bottom
                        const messagesDiv = document.getElementById('chatMessages');
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                )
                .subscribe();
        }
        
        function renderChatMessages() {
            const messagesDiv = document.getElementById('chatMessages');
            
            if (chatMessages.length === 0) {
                messagesDiv.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        üí¨ Aucun message<br>Sois le premier √† parler !
                    </div>
                `;
                return;
            }
            
            let html = '';
            chatMessages.forEach(msg => {
                const time = new Date(msg.created_at).toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                html += `
                    <div class="chat-message">
                        <div class="chat-message-header">
                            <span class="chat-avatar">${msg.avatar}</span>
                            <span class="chat-username">${msg.username}</span>
                            <span class="chat-time">${time}</span>
                        </div>
                        <div class="chat-text">${escapeHtml(msg.message)}</div>
                    </div>
                `;
            });
            
            messagesDiv.innerHTML = html;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Check if logged in
            if (!currentUser) {
                alert('‚ö†Ô∏è Tu dois √™tre connect√© pour chatter !\n\nClique sur üîê SE CONNECTER');
                return;
            }
            
            // Anti-spam check
            const now = Date.now();
            if (now - lastMessageTime < 2000) {
                alert('‚ö†Ô∏è Attends 2 secondes entre chaque message !');
                return;
            }
            
            // Count messages in last minute
            if (now - lastMessageTime < 60000) {
                messageCount++;
                if (messageCount > 5) {
                    alert('‚ö†Ô∏è Maximum 5 messages par minute !\n\nRalentis un peu üòä');
                    return;
                }
            } else {
                messageCount = 1;
            }
            
            lastMessageTime = now;
            
            try {
                const { error } = await supabaseClient
                    .from('chat_messages')
                    .insert([{
                        username: STATE.profile.name,
                        avatar: STATE.profile.avatar,
                        message: message
                    }]);
                
                if (error) throw error;
                
                input.value = '';
                playSound('coinSound');
                
            } catch (error) {
                console.error('Erreur envoi message:', error);
                alert('‚ùå Erreur d\'envoi: ' + error.message);
            }
        }
        
        function showChatNotification() {
            const chatBtn = document.getElementById('chatBtn');
            if (!chatBtn) return;
            
            // Remove existing notification
            const existing = chatBtn.querySelector('.chat-notification');
            if (existing) existing.remove();
            
            // Add new notification
            const notif = document.createElement('div');
            notif.className = 'chat-notification';
            notif.textContent = '!';
            chatBtn.appendChild(notif);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ========== PWA SUPPORT ==========
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service worker can be added later for full PWA support
            });
        }
        
        init();
    </script>
</body>
</html>
